<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ERC-8004 Trading Agent â€” Live Dashboard</title>
  <style>
    :root {
      --bg: #0d1117;
      --surface: #161b22;
      --border: #30363d;
      --text: #c9d1d9;
      --muted: #8b949e;
      --green: #3fb950;
      --red: #f85149;
      --blue: #58a6ff;
      --yellow: #d29922;
      --purple: #bc8cff;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Segoe UI', system-ui, monospace;
      font-size: 14px;
      min-height: 100vh;
    }
    header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header h1 { font-size: 18px; color: var(--blue); }
    .status-dot {
      width: 10px; height: 10px; border-radius: 50%;
      display: inline-block; margin-right: 6px;
    }
    .dot-green { background: var(--green); box-shadow: 0 0 6px var(--green); }
    .dot-red { background: var(--red); }
    .dot-yellow { background: var(--yellow); animation: pulse 1s infinite; }
    @keyframes pulse { 0%,100%{opacity:1}50%{opacity:0.4} }

    main {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
      padding: 20px;
      max-width: 1400px;
      margin: 0 auto;
    }
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
    }
    .card h2 {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--muted);
      margin-bottom: 12px;
    }
    .metric {
      font-size: 28px;
      font-weight: 700;
      font-variant-numeric: tabular-nums;
    }
    .metric.green { color: var(--green); }
    .metric.red { color: var(--red); }
    .metric.blue { color: var(--blue); }
    .sub { font-size: 12px; color: var(--muted); margin-top: 4px; }

    .agent-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-top: 8px;
    }
    .agent-card {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 10px;
      text-align: center;
    }
    .agent-card .name { font-size: 11px; color: var(--muted); }
    .agent-card .action { font-size: 11px; margin-top: 4px; font-weight: 700; }
    .agent-card .action.buy { color: var(--green); }
    .agent-card .action.sell { color: var(--red); }
    .agent-card .action.hold { color: var(--yellow); }

    .events-feed {
      max-height: 300px;
      overflow-y: auto;
      scrollbar-width: thin;
    }
    .event-item {
      padding: 6px 8px;
      margin-bottom: 4px;
      border-radius: 4px;
      font-size: 12px;
      border-left: 3px solid transparent;
      background: var(--bg);
    }
    .event-item.price_update { border-color: var(--blue); }
    .event-item.trade_executed { border-color: var(--green); }
    .event-item.risk_alert { border-color: var(--red); }
    .event-item.ensemble_signal { border-color: var(--purple); }
    .event-item.agent_signal { border-color: var(--yellow); }
    .event-item .evt-time { color: var(--muted); font-size: 10px; float: right; }

    .consensus-badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 700;
      margin-top: 8px;
    }
    .consensus-badge.buy { background: rgba(63,185,80,0.15); color: var(--green); }
    .consensus-badge.sell { background: rgba(248,81,73,0.15); color: var(--red); }
    .consensus-badge.hold { background: rgba(210,153,34,0.15); color: var(--yellow); }

    .price-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 0;
      border-bottom: 1px solid var(--border);
    }
    .price-row:last-child { border-bottom: none; }
    .price-sym { font-weight: 700; }
    .price-val { font-variant-numeric: tabular-nums; }
    .chg.pos { color: var(--green); }
    .chg.neg { color: var(--red); }

    .conn-status {
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .wide { grid-column: 1 / -1; }

    footer {
      text-align: center;
      padding: 16px;
      color: var(--muted);
      font-size: 11px;
    }
  </style>
</head>
<body>
  <header>
    <h1>ERC-8004 Trading Agent</h1>
    <div class="conn-status">
      <span class="status-dot dot-yellow" id="connDot"></span>
      <span id="connLabel">Connecting...</span>
    </div>
  </header>

  <main>
    <div class="card">
      <h2>Total PnL</h2>
      <div class="metric" id="totalPnl">$0.00</div>
      <div class="sub" id="activePositions">0 active positions</div>
    </div>

    <div class="card">
      <h2>Reputation Score</h2>
      <div class="metric blue" id="repScore">0.0</div>
      <div class="sub" id="repDetails">Win rate: 0% - 0 trades</div>
    </div>

    <div class="card">
      <h2>Latest Ensemble Signal</h2>
      <div id="ensembleAction">
        <span class="consensus-badge hold">HOLD</span>
      </div>
      <div class="sub" id="ensembleDetails">No decision yet</div>
    </div>

    <div class="card">
      <h2>Price Feed</h2>
      <div id="priceFeed">
        <div style="color: var(--muted); font-size: 12px;">Awaiting data...</div>
      </div>
    </div>

    <div class="card">
      <h2>Agent Pool</h2>
      <div id="agentPool">
        <div style="color: var(--muted); font-size: 12px;">Loading agents...</div>
      </div>
    </div>

    <div class="card">
      <h2>Risk Status</h2>
      <div class="metric green" id="riskStatus">Normal</div>
      <div class="sub" id="riskDetails">All systems green</div>
    </div>

    <div class="card wide">
      <h2>Live Events Feed</h2>
      <div class="events-feed" id="eventsFeed">
        <div style="color: var(--muted); font-size: 12px; padding: 8px;">
          Waiting for WebSocket connection...
        </div>
      </div>
    </div>
  </main>

  <footer>
    ERC-8004 Trading Agent v0.4.0 - Multi-Agent Coordinator - Live WebSocket Dashboard
  </footer>

  <script>
    var WS_URL = 'ws://' + location.host + '/ws/trading';
    var ws = null;
    var reconnectTimer = null;
    var latestVotes = {};
    var priceFeedData = {};

    function $(id) { return document.getElementById(id); }

    function setConn(state) {
      var dot = $('connDot'), label = $('connLabel');
      if (state === 'connected') {
        dot.className = 'status-dot dot-green';
        label.textContent = 'Connected';
      } else if (state === 'disconnected') {
        dot.className = 'status-dot dot-red';
        label.textContent = 'Disconnected - Reconnecting...';
      } else {
        dot.className = 'status-dot dot-yellow';
        label.textContent = 'Connecting...';
      }
    }

    function fmtPnl(v) {
      var n = parseFloat(v) || 0;
      var sign = n >= 0 ? '+' : '';
      return sign + '$' + n.toFixed(4);
    }

    function fmtTime(iso) {
      if (!iso) return '';
      return new Date(iso).toLocaleTimeString();
    }

    function addEvent(evt) {
      if (evt.type === 'keepalive' || evt.type === 'pong') return;
      var feed = $('eventsFeed');
      var div = document.createElement('div');
      div.className = 'event-item ' + (evt.type || '');
      var time = '<span class="evt-time">' + fmtTime(evt.timestamp) + '</span>';
      var text = '';
      switch (evt.type) {
        case 'price_update':
          var chg = parseFloat(evt.change_pct || 0);
          var chgStr = (chg >= 0 ? '+' : '') + (chg * 100).toFixed(2) + '%';
          text = 'Price: <strong>' + evt.symbol + '</strong> $' + parseFloat(evt.price).toLocaleString() + ' (' + chgStr + ')';
          break;
        case 'trade_executed':
          var pnlStr = evt.pnl != null ? ' PnL: ' + fmtPnl(evt.pnl) : '';
          text = 'Trade: <strong>' + (evt.side || '').toUpperCase() + ' ' + evt.market_id + '</strong> $' + evt.size_usdc + pnlStr;
          break;
        case 'portfolio_update':
          text = 'Portfolio: $' + parseFloat(evt.total_value || 0).toFixed(2) + ' PnL ' + fmtPnl(evt.pnl) + ' ' + evt.active_positions + ' positions';
          break;
        case 'agent_signal':
          text = 'Agent <strong>' + evt.agent_id + '</strong>: ' + (evt.action || '').toUpperCase() + ' (conf: ' + (parseFloat(evt.confidence || 0) * 100).toFixed(0) + '%) on ' + evt.symbol;
          break;
        case 'ensemble_signal':
          var votes = Object.entries(evt.agent_votes || {}).map(function(e) { return e[0] + ':' + e[1]; }).join(' ');
          text = 'Ensemble: <strong>' + (evt.action || '').toUpperCase() + '</strong> (' + (parseFloat(evt.consensus_weight || 0) * 100).toFixed(0) + '% consensus) [' + votes + ']';
          break;
        case 'risk_alert':
          text = 'RISK ALERT [' + (evt.severity || '').toUpperCase() + ']: ' + evt.message;
          break;
        default:
          text = JSON.stringify(evt);
      }
      div.innerHTML = time + text;
      feed.insertBefore(div, feed.firstChild);
      while (feed.children.length > 50) feed.removeChild(feed.lastChild);
    }

    function updatePnl(pnl, positions) {
      var n = parseFloat(pnl) || 0;
      var el = $('totalPnl');
      el.textContent = fmtPnl(n);
      el.className = 'metric ' + (n >= 0 ? 'green' : 'red');
      $('activePositions').textContent = (positions || 0) + ' active positions';
    }

    function renderPriceFeed(feed) {
      var el = $('priceFeed');
      var keys = Object.keys(feed);
      if (!keys.length) return;
      el.innerHTML = keys.map(function(sym) {
        var data = feed[sym];
        var chg = parseFloat(data.change_pct || 0);
        var chgClass = chg >= 0 ? 'pos' : 'neg';
        var chgStr = (chg >= 0 ? '+' : '') + (chg * 100).toFixed(2) + '%';
        return '<div class="price-row"><span class="price-sym">' + sym + '</span><span class="price-val">$' + parseFloat(data.price).toLocaleString() + '</span><span class="chg ' + chgClass + '">' + chgStr + '</span></div>';
      }).join('');
    }

    function renderEnsemble(ens) {
      var action = ens.action || 'hold';
      var weight = parseFloat(ens.consensus_weight || 0);
      $('ensembleAction').innerHTML = '<span class="consensus-badge ' + action + '">' + action.toUpperCase() + '</span>';
      $('ensembleDetails').textContent = (weight * 100).toFixed(0) + '% consensus - ' + fmtTime(ens.timestamp);
      latestVotes = ens.agent_votes || {};
    }

    function renderAgentPool(pool) {
      var agents = pool.agents || [];
      var rate = (parseFloat(pool.consensus_rate || 0) * 100).toFixed(0);
      var html = '<div class="sub" style="margin-bottom:8px">Pool: ' + (pool.pool_size || 0) + ' agents - Consensus: ' + rate + '% - ' + (pool.decision_count || 0) + ' decisions</div>';
      if (agents.length) {
        html += '<div class="agent-grid">' + agents.map(function(id) {
          var vote = latestVotes[id] || 'hold';
          return '<div class="agent-card"><div class="name">' + id + '</div><div class="action ' + vote + '">' + vote.toUpperCase() + '</div></div>';
        }).join('') + '</div>';
      }
      $('agentPool').innerHTML = html;
    }

    function applySnapshot(state) {
      updatePnl(state.total_pnl, state.active_positions);
      if (state.reputation) {
        var rep = state.reputation;
        $('repScore').textContent = parseFloat(rep.aggregate_score || 0).toFixed(2);
        var total = (rep.win_count || 0) + (rep.loss_count || 0);
        var wr = total > 0 ? ((rep.win_count / total) * 100).toFixed(0) : '0';
        $('repDetails').textContent = 'Win rate: ' + wr + '% - ' + (rep.total_feedback || 0) + ' total feedback';
      }
      if (state.price_feed) { priceFeedData = state.price_feed; renderPriceFeed(priceFeedData); }
      if (state.last_ensemble) renderEnsemble(state.last_ensemble);
      if (state.agent_pool) renderAgentPool(state.agent_pool);
    }

    function connect() {
      setConn('connecting');
      try { ws = new WebSocket(WS_URL); } catch(e) { setConn('disconnected'); reconnectTimer = setTimeout(connect, 3000); return; }

      ws.onopen = function() {
        setConn('connected');
        if (reconnectTimer) { clearTimeout(reconnectTimer); reconnectTimer = null; }
      };

      ws.onmessage = function(msg) {
        var evt;
        try { evt = JSON.parse(msg.data); } catch(e) { return; }
        switch (evt.type) {
          case 'snapshot': applySnapshot(evt.state || {}); break;
          case 'price_update':
            priceFeedData[evt.symbol] = {price: evt.price, change_pct: evt.change_pct};
            renderPriceFeed(priceFeedData);
            addEvent(evt);
            break;
          case 'portfolio_update':
            updatePnl(evt.pnl, evt.active_positions);
            addEvent(evt);
            break;
          case 'ensemble_signal': renderEnsemble(evt); addEvent(evt); break;
          case 'risk_alert':
            $('riskStatus').textContent = evt.severity === 'critical' ? 'HALTED' : 'Warning';
            $('riskStatus').style.color = evt.severity === 'critical' ? 'var(--red)' : 'var(--yellow)';
            $('riskDetails').textContent = evt.message;
            addEvent(evt);
            break;
          default: addEvent(evt);
        }
      };

      ws.onerror = function() { setConn('disconnected'); };
      ws.onclose = function() { setConn('disconnected'); reconnectTimer = setTimeout(connect, 3000); };
    }

    connect();
  </script>
</body>
</html>
